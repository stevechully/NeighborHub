{"ast":null,"code":"import{createContext,useContext,useEffect,useState}from\"react\";import{supabase}from\"../lib/supabase\";import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(null);export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(null);const[profile,setProfile]=useState(null);const[loading,setLoading]=useState(true);async function loadProfile(userId){const{data,error}=await supabase.from(\"profiles\").select(\"*, roles(name)\").eq(\"id\",userId).single();if(error){console.error(\"profile error\",error);return null;}return data;}useEffect(()=>{let mounted=true;async function initializeAuth(){try{console.log(\"AuthContext: Starting initialization...\");// 1. Explicitly check for an existing session on mount\nconst{data:{session},error:sessionError}=await supabase.auth.getSession();if(sessionError){console.error(\"AuthContext: Session fetch error:\",sessionError);}if(mounted){var _session$user;const sessionUser=(_session$user=session===null||session===void 0?void 0:session.user)!==null&&_session$user!==void 0?_session$user:null;console.log(\"AuthContext: Initial session user:\",(sessionUser===null||sessionUser===void 0?void 0:sessionUser.email)||\"none\");setUser(sessionUser);if(sessionUser){console.log(\"AuthContext: Fetching profile (non-blocking)...\");// ðŸ’¡ Don't await profile load here to avoid blocking the UI\nloadProfile(sessionUser.id).then(p=>{if(mounted){console.log(\"AuthContext: Profile loaded successfully\");setProfile(p);}}).catch(err=>{console.error(\"AuthContext: Profile load failed intermittently:\",err);});}}}catch(err){console.error(\"AuthContext: Unexpected initialization error:\",err);}finally{if(mounted){console.log(\"AuthContext: Initialization flow complete, setting loading=false\");setLoading(false);}}}initializeAuth();// 2. Listen for subsequent auth state changes (login, logout, etc.)\nconst{data:{subscription}}=supabase.auth.onAuthStateChange(async(event,session)=>{var _session$user2;console.log(\"AuthContext: Auth event fired: \".concat(event));if(!mounted)return;const sessionUser=(_session$user2=session===null||session===void 0?void 0:session.user)!==null&&_session$user2!==void 0?_session$user2:null;setUser(sessionUser);if(sessionUser){loadProfile(sessionUser.id).then(p=>{if(mounted)setProfile(p);});}else{setProfile(null);}setLoading(false);});return()=>{mounted=false;subscription.unsubscribe();};},[]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,profile,loading},children:children});}export function useAuth(){return useContext(AuthContext);}","map":{"version":3,"names":["createContext","useContext","useEffect","useState","supabase","jsx","_jsx","AuthContext","AuthProvider","_ref","children","user","setUser","profile","setProfile","loading","setLoading","loadProfile","userId","data","error","from","select","eq","single","console","mounted","initializeAuth","log","session","sessionError","auth","getSession","_session$user","sessionUser","email","id","then","p","catch","err","subscription","onAuthStateChange","event","_session$user2","concat","unsubscribe","Provider","value","useAuth"],"sources":["/home/steve/amala/client/src/auth/AuthContext.js"],"sourcesContent":["import { createContext, useContext, useEffect, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\n\nconst AuthContext = createContext(null);\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [profile, setProfile] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  async function loadProfile(userId) {\n    const { data, error } = await supabase\n      .from(\"profiles\")\n      .select(\"*, roles(name)\")\n      .eq(\"id\", userId)\n      .single();\n\n    if (error) {\n      console.error(\"profile error\", error);\n      return null;\n    }\n    return data;\n  }\n\n  useEffect(() => {\n    let mounted = true;\n\n\n    async function initializeAuth() {\n      try {\n        console.log(\"AuthContext: Starting initialization...\");\n\n        // 1. Explicitly check for an existing session on mount\n        const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n        if (sessionError) {\n          console.error(\"AuthContext: Session fetch error:\", sessionError);\n        }\n\n        if (mounted) {\n          const sessionUser = session?.user ?? null;\n          console.log(\"AuthContext: Initial session user:\", sessionUser?.email || \"none\");\n          setUser(sessionUser);\n\n          if (sessionUser) {\n            console.log(\"AuthContext: Fetching profile (non-blocking)...\");\n            // ðŸ’¡ Don't await profile load here to avoid blocking the UI\n            loadProfile(sessionUser.id).then(p => {\n              if (mounted) {\n                console.log(\"AuthContext: Profile loaded successfully\");\n                setProfile(p);\n              }\n            }).catch(err => {\n              console.error(\"AuthContext: Profile load failed intermittently:\", err);\n            });\n          }\n        }\n      } catch (err) {\n        console.error(\"AuthContext: Unexpected initialization error:\", err);\n      } finally {\n        if (mounted) {\n          console.log(\"AuthContext: Initialization flow complete, setting loading=false\");\n          setLoading(false);\n        }\n      }\n    }\n\n    initializeAuth();\n\n    // 2. Listen for subsequent auth state changes (login, logout, etc.)\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      async (event, session) => {\n        console.log(`AuthContext: Auth event fired: ${event}`);\n        if (!mounted) return;\n\n        const sessionUser = session?.user ?? null;\n        setUser(sessionUser);\n\n        if (sessionUser) {\n          loadProfile(sessionUser.id).then(p => {\n            if (mounted) setProfile(p);\n          });\n        } else {\n          setProfile(null);\n        }\n\n        setLoading(false);\n      }\n    );\n\n    return () => {\n      mounted = false;\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  return (\n    <AuthContext.Provider value={{ user, profile, loading }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  return useContext(AuthContext);\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}