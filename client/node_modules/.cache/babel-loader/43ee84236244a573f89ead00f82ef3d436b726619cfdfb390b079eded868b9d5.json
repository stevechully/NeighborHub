{"ast":null,"code":"var _jsxFileName = \"/home/steve/amala/client/src/auth/AuthContext.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport { createContext, useContext, useEffect, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst AuthContext = /*#__PURE__*/createContext(null);\nexport function AuthProvider({\n  children\n}) {\n  _s();\n  const [user, setUser] = useState(null);\n  const [profile, setProfile] = useState(null);\n  const [loading, setLoading] = useState(true);\n  async function loadProfile(userId) {\n    const {\n      data,\n      error\n    } = await supabase.from(\"profiles\").select(\"*, roles(name)\").eq(\"id\", userId).single();\n    if (error) {\n      console.error(\"profile error\", error);\n      return null;\n    }\n    return data;\n  }\n\n  // Unified Logout System\n  const logout = async () => {\n    try {\n      // 1. Terminate the Supabase session\n      await supabase.auth.signOut();\n    } catch (err) {\n      console.error(\"Logout failed:\", err.message);\n    } finally {\n      // 2. Explicitly clear local state\n      // We do this in 'finally' to ensure the UI updates even if the network call fails\n      setUser(null);\n      setProfile(null);\n    }\n  };\n  useEffect(() => {\n    let mounted = true;\n    async function initializeAuth() {\n      try {\n        console.log(\"AuthContext: Starting initialization...\");\n\n        // 1. Explicitly check for an existing session on mount\n        const {\n          data: {\n            session\n          },\n          error: sessionError\n        } = await supabase.auth.getSession();\n        if (sessionError) {\n          console.error(\"AuthContext: Session fetch error:\", sessionError);\n        }\n        if (mounted) {\n          var _session$user;\n          const sessionUser = (_session$user = session === null || session === void 0 ? void 0 : session.user) !== null && _session$user !== void 0 ? _session$user : null;\n          console.log(\"AuthContext: Initial session user:\", (sessionUser === null || sessionUser === void 0 ? void 0 : sessionUser.email) || \"none\");\n          setUser(sessionUser);\n          if (sessionUser) {\n            console.log(\"AuthContext: Fetching profile (non-blocking)...\");\n            loadProfile(sessionUser.id).then(p => {\n              if (mounted) {\n                console.log(\"AuthContext: Profile loaded successfully\");\n                setProfile(p);\n              }\n            }).catch(err => {\n              console.error(\"AuthContext: Profile load failed intermittently:\", err);\n            });\n          }\n        }\n      } catch (err) {\n        console.error(\"AuthContext: Unexpected initialization error:\", err);\n      } finally {\n        if (mounted) {\n          console.log(\"AuthContext: Initialization flow complete, setting loading=false\");\n          setLoading(false);\n        }\n      }\n    }\n    initializeAuth();\n\n    // 2. Listen for subsequent auth state changes (login, logout, etc.)\n    const {\n      data: {\n        subscription\n      }\n    } = supabase.auth.onAuthStateChange(async (event, session) => {\n      var _session$user2;\n      console.log(`AuthContext: Auth event fired: ${event}`);\n      if (!mounted) return;\n      const sessionUser = (_session$user2 = session === null || session === void 0 ? void 0 : session.user) !== null && _session$user2 !== void 0 ? _session$user2 : null;\n      setUser(sessionUser);\n      if (sessionUser) {\n        loadProfile(sessionUser.id).then(p => {\n          if (mounted) setProfile(p);\n        });\n      } else {\n        setProfile(null);\n      }\n      setProfile(null); // Clear profile on logout event\n      setLoading(false);\n    });\n    return () => {\n      mounted = false;\n      subscription.unsubscribe();\n    };\n  }, []);\n  return (\n    /*#__PURE__*/\n    // Added 'logout' to the Provider value so it is accessible via useAuth()\n    _jsxDEV(AuthContext.Provider, {\n      value: {\n        user,\n        profile,\n        loading,\n        logout\n      },\n      children: children\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 113,\n      columnNumber: 5\n    }, this)\n  );\n}\n_s(AuthProvider, \"DYSpA4ZauWKW8e4CNkO4ayA+RbM=\");\n_c = AuthProvider;\nexport function useAuth() {\n  _s2();\n  return useContext(AuthContext);\n}\n_s2(useAuth, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["createContext","useContext","useEffect","useState","supabase","jsxDEV","_jsxDEV","AuthContext","AuthProvider","children","_s","user","setUser","profile","setProfile","loading","setLoading","loadProfile","userId","data","error","from","select","eq","single","console","logout","auth","signOut","err","message","mounted","initializeAuth","log","session","sessionError","getSession","_session$user","sessionUser","email","id","then","p","catch","subscription","onAuthStateChange","event","_session$user2","unsubscribe","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","_c","useAuth","_s2","$RefreshReg$"],"sources":["/home/steve/amala/client/src/auth/AuthContext.js"],"sourcesContent":["import { createContext, useContext, useEffect, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\n\nconst AuthContext = createContext(null);\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [profile, setProfile] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  async function loadProfile(userId) {\n    const { data, error } = await supabase\n      .from(\"profiles\")\n      .select(\"*, roles(name)\")\n      .eq(\"id\", userId)\n      .single();\n\n    if (error) {\n      console.error(\"profile error\", error);\n      return null;\n    }\n    return data;\n  }\n\n  // Unified Logout System\n  const logout = async () => {\n    try {\n      // 1. Terminate the Supabase session\n      await supabase.auth.signOut();\n    } catch (err) {\n      console.error(\"Logout failed:\", err.message);\n    } finally {\n      // 2. Explicitly clear local state\n      // We do this in 'finally' to ensure the UI updates even if the network call fails\n      setUser(null);\n      setProfile(null);\n    }\n  };\n\n  useEffect(() => {\n    let mounted = true;\n\n    async function initializeAuth() {\n      try {\n        console.log(\"AuthContext: Starting initialization...\");\n\n        // 1. Explicitly check for an existing session on mount\n        const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n        if (sessionError) {\n          console.error(\"AuthContext: Session fetch error:\", sessionError);\n        }\n\n        if (mounted) {\n          const sessionUser = session?.user ?? null;\n          console.log(\"AuthContext: Initial session user:\", sessionUser?.email || \"none\");\n          setUser(sessionUser);\n\n          if (sessionUser) {\n            console.log(\"AuthContext: Fetching profile (non-blocking)...\");\n            loadProfile(sessionUser.id).then(p => {\n              if (mounted) {\n                console.log(\"AuthContext: Profile loaded successfully\");\n                setProfile(p);\n              }\n            }).catch(err => {\n              console.error(\"AuthContext: Profile load failed intermittently:\", err);\n            });\n          }\n        }\n      } catch (err) {\n        console.error(\"AuthContext: Unexpected initialization error:\", err);\n      } finally {\n        if (mounted) {\n          console.log(\"AuthContext: Initialization flow complete, setting loading=false\");\n          setLoading(false);\n        }\n      }\n    }\n\n    initializeAuth();\n\n    // 2. Listen for subsequent auth state changes (login, logout, etc.)\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      async (event, session) => {\n        console.log(`AuthContext: Auth event fired: ${event}`);\n        if (!mounted) return;\n\n        const sessionUser = session?.user ?? null;\n        setUser(sessionUser);\n\n        if (sessionUser) {\n          loadProfile(sessionUser.id).then(p => {\n            if (mounted) setProfile(p);\n          });\n        } else {\n          setProfile(null);\n        }\n\n        setProfile(null); // Clear profile on logout event\n        setLoading(false);\n      }\n    );\n\n    return () => {\n      mounted = false;\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  return (\n    // Added 'logout' to the Provider value so it is accessible via useAuth()\n    <AuthContext.Provider value={{ user, profile, loading, logout }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  return useContext(AuthContext);\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}