{"ast":null,"code":"import{useEffect,useState,useCallback}from\"react\";import{useAuth}from\"../../auth/AuthContext\";import{fetchVisitors,fetchParcels}from\"../../api/visitorParcel.api\";import useParcelNotifications from\"../../hooks/useParcelNotifications\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function MyParcelsPage(){var _profile$roles,_profile$user_roles;const{profile,loading:authLoading}=useAuth();const[visitors,setVisitors]=useState([]);const[parcels,setParcels]=useState([]);const[loading,setLoading]=useState(true);const userId=profile===null||profile===void 0?void 0:profile.id;const roleName=(profile===null||profile===void 0?void 0:(_profile$roles=profile.roles)===null||_profile$roles===void 0?void 0:_profile$roles.name)||(profile===null||profile===void 0?void 0:profile.role)||(profile===null||profile===void 0?void 0:(_profile$user_roles=profile.user_roles)===null||_profile$user_roles===void 0?void 0:_profile$user_roles.role)||null;const isResident=roleName===\"RESIDENT\";console.log(\"ðŸŸ¢ MyParcelsPage Mounted\");console.log(\"ðŸŸ¢ userId for realtime:\",userId);// âœ… FIXED: Individual fetches with safe .catch() handlers\nconst loadData=useCallback(async()=>{try{setLoading(true);// Attempt to fetch visitors safely\nconst vData=await fetchVisitors().catch(err=>{console.log(\"âŒ Visitors fetch failed (likely RLS):\",err.message);return[];// Return empty array on fail\n});// Attempt to fetch parcels safely\nconst pData=await fetchParcels().catch(err=>{console.log(\"âŒ Parcels fetch failed:\",err.message);return[];});setVisitors(vData||[]);setParcels(pData||[]);}finally{setLoading(false);}},[]);const onNewParcel=useCallback(parcel=>{alert(\"\\uD83D\\uDCE6 New parcel received from \".concat(parcel.courier_name,\"!\"));loadData();},[loadData]);useParcelNotifications(userId,onNewParcel);useEffect(()=>{if(!authLoading&&profile)loadData();},[authLoading,profile,loadData]);if(authLoading||!profile){return/*#__PURE__*/_jsx(\"div\",{style:{padding:40},children:\"Verifying session...\"});}if(!isResident){return/*#__PURE__*/_jsxs(\"div\",{style:{padding:40,textAlign:'center'},children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83D\\uDEAB Access Denied\"}),/*#__PURE__*/_jsx(\"p\",{children:\"This page is for residents only.\"})]});}return/*#__PURE__*/_jsxs(\"div\",{style:{padding:20},children:[/*#__PURE__*/_jsx(\"h2\",{children:\"My Parcels & Visitors\"}),/*#__PURE__*/_jsxs(\"div\",{style:cardStyle,children:[/*#__PURE__*/_jsx(\"h3\",{children:\"My Visitors\"}),loading?/*#__PURE__*/_jsx(\"p\",{children:\"Loading...\"}):visitors.length===0?/*#__PURE__*/_jsx(\"p\",{children:\"No visitors found.\"}):/*#__PURE__*/_jsxs(\"table\",{width:\"100%\",cellPadding:\"10\",style:{borderCollapse:\"collapse\"},children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{style:{background:\"#f8f9fa\",textAlign:\"left\"},children:[/*#__PURE__*/_jsx(\"th\",{children:\"Name\"}),/*#__PURE__*/_jsx(\"th\",{children:\"Purpose\"}),/*#__PURE__*/_jsx(\"th\",{children:\"Entry\"}),/*#__PURE__*/_jsx(\"th\",{children:\"Exit\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:visitors.map(v=>/*#__PURE__*/_jsxs(\"tr\",{style:{borderBottom:\"1px solid #eee\"},children:[/*#__PURE__*/_jsx(\"td\",{children:v.visitor_name}),/*#__PURE__*/_jsx(\"td\",{children:v.purpose}),/*#__PURE__*/_jsx(\"td\",{children:new Date(v.entry_time).toLocaleString()}),/*#__PURE__*/_jsx(\"td\",{children:v.exit_time?new Date(v.exit_time).toLocaleString():\"Inside\"})]},v.id))})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:cardStyle,children:[/*#__PURE__*/_jsx(\"h3\",{children:\"My Parcels\"}),loading?/*#__PURE__*/_jsx(\"p\",{children:\"Loading...\"}):parcels.length===0?/*#__PURE__*/_jsx(\"p\",{children:\"No parcels found.\"}):/*#__PURE__*/_jsxs(\"table\",{width:\"100%\",cellPadding:\"10\",style:{borderCollapse:\"collapse\"},children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{style:{background:\"#f8f9fa\",textAlign:\"left\"},children:[/*#__PURE__*/_jsx(\"th\",{children:\"Courier\"}),/*#__PURE__*/_jsx(\"th\",{children:\"Status\"}),/*#__PURE__*/_jsx(\"th\",{children:\"Received At\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:parcels.map(p=>/*#__PURE__*/_jsxs(\"tr\",{style:{borderBottom:\"1px solid #eee\"},children:[/*#__PURE__*/_jsxs(\"td\",{children:[p.courier_name,\" \",p.tracking_number&&\"(\".concat(p.tracking_number,\")\")]}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(\"strong\",{children:p.status})}),/*#__PURE__*/_jsx(\"td\",{children:new Date(p.received_at).toLocaleString()})]},p.id))})]})]})]});}const cardStyle={background:\"#fff\",padding:20,borderRadius:8,marginBottom:20,boxShadow:'0 2px 4px rgba(0,0,0,0.1)'};","map":{"version":3,"names":["useEffect","useState","useCallback","useAuth","fetchVisitors","fetchParcels","useParcelNotifications","jsx","_jsx","jsxs","_jsxs","MyParcelsPage","_profile$roles","_profile$user_roles","profile","loading","authLoading","visitors","setVisitors","parcels","setParcels","setLoading","userId","id","roleName","roles","name","role","user_roles","isResident","console","log","loadData","vData","catch","err","message","pData","onNewParcel","parcel","alert","concat","courier_name","style","padding","children","textAlign","cardStyle","length","width","cellPadding","borderCollapse","background","map","v","borderBottom","visitor_name","purpose","Date","entry_time","toLocaleString","exit_time","p","tracking_number","status","received_at","borderRadius","marginBottom","boxShadow"],"sources":["/home/steve/amala/client/src/pages/gate/MyParcelsPage.js"],"sourcesContent":["import { useEffect, useState, useCallback } from \"react\";\nimport { useAuth } from \"../../auth/AuthContext\";\nimport { fetchVisitors, fetchParcels } from \"../../api/visitorParcel.api\";\nimport useParcelNotifications from \"../../hooks/useParcelNotifications\"; \n\nexport default function MyParcelsPage() {\n  const { profile, loading: authLoading } = useAuth();\n  const [visitors, setVisitors] = useState([]);\n  const [parcels, setParcels] = useState([]);\n  const [loading, setLoading] = useState(true);\n\n  const userId = profile?.id; \n  const roleName = profile?.roles?.name || profile?.role || profile?.user_roles?.role || null;\n  const isResident = roleName === \"RESIDENT\";\n  console.log(\"ðŸŸ¢ MyParcelsPage Mounted\");\n  console.log(\"ðŸŸ¢ userId for realtime:\", userId)\n\n  // âœ… FIXED: Individual fetches with safe .catch() handlers\n  const loadData = useCallback(async () => {\n    try {\n      setLoading(true);\n\n      // Attempt to fetch visitors safely\n      const vData = await fetchVisitors().catch((err) => {\n        console.log(\"âŒ Visitors fetch failed (likely RLS):\", err.message);\n        return []; // Return empty array on fail\n      });\n\n      // Attempt to fetch parcels safely\n      const pData = await fetchParcels().catch((err) => {\n        console.log(\"âŒ Parcels fetch failed:\", err.message);\n        return [];\n      });\n\n      setVisitors(vData || []);\n      setParcels(pData || []);\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  const onNewParcel = useCallback((parcel) => {\n    alert(`ðŸ“¦ New parcel received from ${parcel.courier_name}!`);\n    loadData(); \n  }, [loadData]);\n\n  useParcelNotifications(userId, onNewParcel);\n\n  useEffect(() => {\n    if (!authLoading && profile) loadData();\n  }, [authLoading, profile, loadData]);\n\n  if (authLoading || !profile) {\n    return <div style={{ padding: 40 }}>Verifying session...</div>;\n  }\n\n  if (!isResident) {\n    return (\n      <div style={{ padding: 40, textAlign: 'center' }}>\n        <h3>ðŸš« Access Denied</h3>\n        <p>This page is for residents only.</p>\n      </div>\n    );\n  }\n\n  return (\n    <div style={{ padding: 20 }}>\n      <h2>My Parcels & Visitors</h2>\n      \n      {/* VISITORS SECTION */}\n      <div style={cardStyle}>\n        <h3>My Visitors</h3>\n        {loading ? <p>Loading...</p> : visitors.length === 0 ? (\n          <p>No visitors found.</p>\n        ) : (\n          <table width=\"100%\" cellPadding=\"10\" style={{ borderCollapse: \"collapse\" }}>\n            <thead>\n              <tr style={{ background: \"#f8f9fa\", textAlign: \"left\" }}>\n                <th>Name</th><th>Purpose</th><th>Entry</th><th>Exit</th>\n              </tr>\n            </thead>\n            <tbody>\n              {visitors.map(v => (\n                <tr key={v.id} style={{ borderBottom: \"1px solid #eee\" }}>\n                  <td>{v.visitor_name}</td>\n                  <td>{v.purpose}</td>\n                  <td>{new Date(v.entry_time).toLocaleString()}</td>\n                  <td>{v.exit_time ? new Date(v.exit_time).toLocaleString() : \"Inside\"}</td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n\n      {/* PARCELS SECTION */}\n      <div style={cardStyle}>\n        <h3>My Parcels</h3>\n        {loading ? <p>Loading...</p> : parcels.length === 0 ? (\n          <p>No parcels found.</p>\n        ) : (\n          <table width=\"100%\" cellPadding=\"10\" style={{ borderCollapse: \"collapse\" }}>\n            <thead>\n              <tr style={{ background: \"#f8f9fa\", textAlign: \"left\" }}>\n                <th>Courier</th><th>Status</th><th>Received At</th>\n              </tr>\n            </thead>\n            <tbody>\n              {parcels.map(p => (\n                <tr key={p.id} style={{ borderBottom: \"1px solid #eee\" }}>\n                  <td>{p.courier_name} {p.tracking_number && `(${p.tracking_number})`}</td>\n                  <td><strong>{p.status}</strong></td>\n                  <td>{new Date(p.received_at).toLocaleString()}</td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n    </div>\n  );\n}\n\nconst cardStyle = {\n  background: \"#fff\",\n  padding: 20,\n  borderRadius: 8,\n  marginBottom: 20,\n  boxShadow: '0 2px 4px rgba(0,0,0,0.1)'\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}