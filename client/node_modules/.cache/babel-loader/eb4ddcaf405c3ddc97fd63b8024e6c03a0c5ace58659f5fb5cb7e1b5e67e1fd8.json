{"ast":null,"code":"import{createContext,useContext,useEffect,useState}from\"react\";import{supabase}from\"../lib/supabase\";import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(null);export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(null);const[profile,setProfile]=useState(null);const[loading,setLoading]=useState(true);async function loadProfile(userId){const{data,error}=await supabase.from(\"profiles\").select(\"*, roles(name)\").eq(\"id\",userId).single();if(error){console.error(\"profile error\",error);return null;}return data;}// Unified Logout System\nconst logout=async()=>{try{// 1. Terminate the Supabase session\nawait supabase.auth.signOut();}catch(err){console.error(\"Logout failed:\",err.message);}finally{// 2. Explicitly clear local state\n// We do this in 'finally' to ensure the UI updates even if the network call fails\nsetUser(null);setProfile(null);}};useEffect(()=>{let mounted=true;async function initializeAuth(){try{console.log(\"AuthContext: Starting initialization...\");// 1. Explicitly check for an existing session on mount\nconst{data:{session},error:sessionError}=await supabase.auth.getSession();if(sessionError){console.error(\"AuthContext: Session fetch error:\",sessionError);}if(mounted){var _session$user;const sessionUser=(_session$user=session===null||session===void 0?void 0:session.user)!==null&&_session$user!==void 0?_session$user:null;console.log(\"AuthContext: Initial session user:\",(sessionUser===null||sessionUser===void 0?void 0:sessionUser.email)||\"none\");setUser(sessionUser);if(sessionUser){console.log(\"AuthContext: Fetching profile (non-blocking)...\");loadProfile(sessionUser.id).then(p=>{if(mounted){console.log(\"AuthContext: Profile loaded successfully\");setProfile(p);}}).catch(err=>{console.error(\"AuthContext: Profile load failed intermittently:\",err);});}}}catch(err){console.error(\"AuthContext: Unexpected initialization error:\",err);}finally{if(mounted){console.log(\"AuthContext: Initialization flow complete, setting loading=false\");setLoading(false);}}}initializeAuth();// 2. Listen for subsequent auth state changes (login, logout, etc.)\nconst{data:{subscription}}=supabase.auth.onAuthStateChange(async(event,session)=>{var _session$user2;console.log(\"AuthContext: Auth event fired: \".concat(event));if(!mounted)return;const sessionUser=(_session$user2=session===null||session===void 0?void 0:session.user)!==null&&_session$user2!==void 0?_session$user2:null;setUser(sessionUser);if(sessionUser){loadProfile(sessionUser.id).then(p=>{if(mounted)setProfile(p);});}else{setProfile(null);}setProfile(null);// Clear profile on logout event\nsetLoading(false);});return()=>{mounted=false;subscription.unsubscribe();};},[]);return(/*#__PURE__*/// Added 'logout' to the Provider value so it is accessible via useAuth()\n_jsx(AuthContext.Provider,{value:{user,profile,loading,logout},children:children}));}export function useAuth(){return useContext(AuthContext);}","map":{"version":3,"names":["createContext","useContext","useEffect","useState","supabase","jsx","_jsx","AuthContext","AuthProvider","_ref","children","user","setUser","profile","setProfile","loading","setLoading","loadProfile","userId","data","error","from","select","eq","single","console","logout","auth","signOut","err","message","mounted","initializeAuth","log","session","sessionError","getSession","_session$user","sessionUser","email","id","then","p","catch","subscription","onAuthStateChange","event","_session$user2","concat","unsubscribe","Provider","value","useAuth"],"sources":["/home/steve/amala/client/src/auth/AuthContext.js"],"sourcesContent":["import { createContext, useContext, useEffect, useState } from \"react\";\nimport { supabase } from \"../lib/supabase\";\n\nconst AuthContext = createContext(null);\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [profile, setProfile] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  async function loadProfile(userId) {\n    const { data, error } = await supabase\n      .from(\"profiles\")\n      .select(\"*, roles(name)\")\n      .eq(\"id\", userId)\n      .single();\n\n    if (error) {\n      console.error(\"profile error\", error);\n      return null;\n    }\n    return data;\n  }\n\n  // Unified Logout System\n  const logout = async () => {\n    try {\n      // 1. Terminate the Supabase session\n      await supabase.auth.signOut();\n    } catch (err) {\n      console.error(\"Logout failed:\", err.message);\n    } finally {\n      // 2. Explicitly clear local state\n      // We do this in 'finally' to ensure the UI updates even if the network call fails\n      setUser(null);\n      setProfile(null);\n    }\n  };\n\n  useEffect(() => {\n    let mounted = true;\n\n    async function initializeAuth() {\n      try {\n        console.log(\"AuthContext: Starting initialization...\");\n\n        // 1. Explicitly check for an existing session on mount\n        const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n        if (sessionError) {\n          console.error(\"AuthContext: Session fetch error:\", sessionError);\n        }\n\n        if (mounted) {\n          const sessionUser = session?.user ?? null;\n          console.log(\"AuthContext: Initial session user:\", sessionUser?.email || \"none\");\n          setUser(sessionUser);\n\n          if (sessionUser) {\n            console.log(\"AuthContext: Fetching profile (non-blocking)...\");\n            loadProfile(sessionUser.id).then(p => {\n              if (mounted) {\n                console.log(\"AuthContext: Profile loaded successfully\");\n                setProfile(p);\n              }\n            }).catch(err => {\n              console.error(\"AuthContext: Profile load failed intermittently:\", err);\n            });\n          }\n        }\n      } catch (err) {\n        console.error(\"AuthContext: Unexpected initialization error:\", err);\n      } finally {\n        if (mounted) {\n          console.log(\"AuthContext: Initialization flow complete, setting loading=false\");\n          setLoading(false);\n        }\n      }\n    }\n\n    initializeAuth();\n\n    // 2. Listen for subsequent auth state changes (login, logout, etc.)\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      async (event, session) => {\n        console.log(`AuthContext: Auth event fired: ${event}`);\n        if (!mounted) return;\n\n        const sessionUser = session?.user ?? null;\n        setUser(sessionUser);\n\n        if (sessionUser) {\n          loadProfile(sessionUser.id).then(p => {\n            if (mounted) setProfile(p);\n          });\n        } else {\n          setProfile(null);\n        }\n\n        setProfile(null); // Clear profile on logout event\n        setLoading(false);\n      }\n    );\n\n    return () => {\n      mounted = false;\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  return (\n    // Added 'logout' to the Provider value so it is accessible via useAuth()\n    <AuthContext.Provider value={{ user, profile, loading, logout }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  return useContext(AuthContext);\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}